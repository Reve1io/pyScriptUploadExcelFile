name: CI/CD Deploy Flask App

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å pytest, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Å—Ç—ã
          # pytest

      - name: Deploy to remote server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "üöÄ Starting deployment..."
            
            cd /home/pyScriptUploadExcelFile
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git pull origin master
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            source venv/bin/activate
            pip install -r requirements.txt
            
            # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 5001
            echo "üî´ Killing processes on port 5001..."
            sudo kill -9 $(sudo lsof -t -i:5001) 2>/dev/null || true
            sleep 2
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
            echo "üîÑ Restarting flaskapp service..."
            sudo systemctl daemon-reload
            sudo systemctl restart flaskapp
            
            # –î–∞–µ–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∑–∞–ø—É—Å–∫
            sleep 10
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            if sudo systemctl is-active --quiet flaskapp; then
              echo "‚úÖ Service restarted successfully"
            else
              echo "‚ùå Service failed to start"
              sudo systemctl status flaskapp
              exit 1
            fi
